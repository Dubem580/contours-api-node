
// **********************************************************

'use strict';

// **********************************************************

var math = require('mathjs');


// Distance values for F(50,50) curves  - 26 data points
var D50 = [ 1.609344, 3.218688, 4.828032, 6.437376, 8.046720, 16.09344, 32.18688, 48.28032, 64.37376, 80.46720, 96.56064, 112.65408, 128.74752, 144.84096, 160.93440, 177.02784, 193.12128, 209.21472, 225.30816, 241.40160, 257.49504, 273.58848, 289.68192, 305.77536, 321.86880];

// Distance values for F(50,10) curves
// Distance of D10(31) added to smooth out the graph and interpolation
// for the rarely used F(50,10) curve at (almost) 500 km
var D10 = [16.09344, 32.18688, 48.28032, 64.37376, 80.46720, 96.56064, 112.65408, 128.74752, 144.84096, 160.93440, 177.02784, 193.12128, 209.21472, 225.30816, 241.40160, 257.49504, 273.58848, 289.68192, 305.77536, 321.86880, 337.96224, 354.05568, 370.14912, 386.24256, 402.33600, 418.42944, 434.52288, 450.61632, 466.70976, 482.80320, 498.89644, 0.0];

// Height values H10, H50 in meters 
var H50 = [30.48, 60.96, 121.92, 182.88, 243.84, 304.80, 381.00, 457.20, 533.40, 609.60, 914.40, 1219.20, 1524.00];
var H10 = [30.48, 60.96, 121.92, 182.88, 243.84, 304.80, 381.00, 457.20, 533.40, 609.60, 914.40, 1219.20, 1524.00];

//console.log('D50: ' + D50.length);
//console.log('D10: ' + D10.length);
//console.log('H50: ' + H50.length);
//console.log('H10: ' + H10.length);

//************************************************************************
//  F(50,50) FIELD STRENGTH DATA FOR THE LOW VHF PROPAGATION CURVE.  (FM AND TV CHANNELS 2 THROUGH 6 )  --  (13 points * 25 curves = 325) + 1                         *
//***********************************************************************

var F55LV = [  
	92., 79.7 ,72.7 ,67.8 ,
	64. ,52. ,39.4 ,31. ,25.3 ,20.3 ,16.2 ,12.8 ,9.8 ,6.9 ,4. ,1.5 ,
	-1.1 ,-3.6 ,-5.8 ,-8.1 ,-10.6 ,-13. ,-15.1 ,-17.2 ,-19.2 ,98. ,
	85.9 ,79. ,73.8 ,70. ,58. ,45.5 ,37. ,29.5 ,23.5 ,18.1 ,14.5 ,
	11. ,8.2 ,5.5 ,2.9 ,.3 ,-2.2 ,-4.8 ,-7. ,-9.4 ,-11.7 ,-14. ,
	-16.1 ,-18.3 ,100.6 ,91. ,84.8 ,80. ,76. ,64. ,51.5 ,43. ,35.5 ,
	28.8 ,22. ,17.1 ,13.4 ,10.2 ,7.4 ,4.8 ,2.2 ,-.3 ,-3. ,-5.2 ,-7.6 ,
	-10. ,-12.2 ,-14.6 ,-16.9 ,101.5 ,93.4 ,87.8 ,83.3 ,79.6 ,67.6 ,
	55. ,46.7 ,39. ,32. ,25.3 ,19.8 ,15.2 ,11.8 ,8.9 ,6. ,3.7 ,1. ,
	-1.4 ,-3.9 ,-6.1 ,-8.7 ,-11. ,-13.2 ,-15.6 ,101.9 ,94.6 ,89.4 ,
	85.4 ,82. ,70. ,57.6 ,49. ,41.5 ,34.4 ,27.7 ,22. ,17. ,13.1 ,
	10.1 ,7.2 ,4.8 ,2. ,-.3 ,-2.7 ,-5.1 ,-7.6 ,-10. ,-12.1 ,-14.6 ,
	102. ,95. ,90.4 ,86.8 ,83.7 ,72. ,59.6 ,51. ,43.6 ,36.7 ,29.9 ,
	23.9 ,18.8 ,14.7 ,11.5 ,8.4 ,5.7 ,3. ,.6 ,-1.8 ,-4.2 ,-6.6 ,-9. ,
	-11.2 ,-13.6 ,102.1 ,95.6 ,91.2 ,87.7 ,85. ,73.9 ,61.7 ,53.2 ,
	45.9 ,39.1 ,32. ,26. ,21. ,16.8 ,13.1 ,9.9 ,7. ,4.1 ,1.7 ,-.7 ,
	-3.2 ,-5.6 ,-8. ,-10.2 ,-12.5 ,102.2 ,95.9 ,91.8 ,88.3 ,85.8 ,
	75.4 ,63.3 ,55.1 ,47.9 ,41.5 ,34.4 ,28.3 ,23.2 ,18.8 ,14.9 ,11.1 ,
	8. ,5.2 ,2.7 ,.2 ,-2.2 ,-4.6 ,-7. ,-9.2 ,-11.6 ,102.3 ,96. ,92. ,
	88.9 ,86.3 ,76.7 ,64.9 ,57. ,50. ,43.5 ,36.7 ,30.7 ,25.2 ,20.4 ,
	16. ,12.5 ,9.1 ,6.2 ,3.8 ,1.1 ,-1.3 ,-3.6 ,-6.1 ,-8.4 ,-10.6 ,
	102.4 ,96.1 ,92.2 ,89.2 ,86.7 ,77.9 ,66.2 ,58.5 ,51.5 ,45. ,38.2 ,
	32.4 ,27. ,22. ,17.3 ,13.7 ,10.1 ,7.1 ,4.6 ,2. ,-.4 ,-2.7 ,-5.1 ,
	-7.6 ,-10. ,102.5 ,96.3 ,92.5 ,89.9 ,87.6 ,80.2 ,70. ,62.6 ,55.4 ,
	48.9 ,42.5 ,36.9 ,31. ,25.7 ,21. ,17.1 ,13.6 ,10.3 ,7.8 ,5.1 ,
	2.8 ,.5 ,-2.1 ,-4.5 ,-6.8 ,102.5 ,96.5 ,92.5 ,90.1 ,88. ,81.3 ,
	72.4 ,65. ,57.8 ,51.2 ,44.9 ,39.1 ,33.2 ,28.1 ,23.5 ,19.8 ,16.1 ,
	13. ,10.4 ,8. ,5.5 ,3.1 ,.6 ,-2. ,-4.1 ,102.5 ,96.5 ,92.5 ,90.2 ,
	88.1 ,81.9 ,74.2 ,66.5 ,59.6 ,53. ,46.4 ,40.8 ,35. ,30. ,25.5 ,
	21.8 ,18.3 ,15. ,12.4 ,10. ,7.7 ,5.1 ,2.8 ,.2 ,-2., 0.0
	];

	//console.log('F55LV: ' + F55LV.length);
	
//***********************************************************************
//  F(50,10)  FIELD STRENGTH DATA  FOR THE LOW VHF PROPAGATION CURVE.  ( FM AND TV CHANNELS 2 THROUGH 6 ) -- (13 points * 31 curves = 403) + 1                                *
//**********************************************************************/
// Includes a derived Interfering curve (31) to smooth out the graph and interpolation for the rarely used F(50,10) curve at 498.89644 km


var F51LV = [
	52.2 ,41.4 ,36.4 ,33. ,
	30. ,26.7 ,23.5 ,20.4 ,17.4 ,14.5 ,11.5 ,8.5 ,5.9 ,3. ,.6 ,-2. ,
	-4.3 ,-6.6 ,-8.7 ,-10.5 ,-12.5 ,-14.6 ,-16.6 ,-18.6 ,-20.5 ,
	-22.4 ,-24.3 ,-26.2 ,-28.1 ,-30. ,-31.9 ,58.4 ,47. ,40.9 ,36. ,
	31.9 ,28. ,24.9 ,22. ,19. ,16.1 ,13.1 ,10.1 ,7.7 ,4.9 ,2. ,-.4 ,
	-3. ,-5.1 ,-7.4 ,-9.4 ,-11.4 ,-13.4 ,-15.5 ,-17.4 ,-19.3 ,-21.2 ,
	-23.2 ,-25. ,-27. ,-29. ,-31. ,64.3 ,53. ,45.9 ,39.9 ,35. ,30.5 ,
	26.9 ,24. ,20.9 ,18.2 ,15.3 ,12.4 ,9.8 ,6.9 ,4.1 ,1.6 ,-1. ,-3.4 ,
	-5.8 ,-8. ,-10.1 ,-12. ,-14.1 ,-16. ,-18. ,-19.9 ,-21.9 ,-23.7 ,
	-25.6 ,-27.4 ,-29.2 ,68. ,56.5 ,49. ,43. ,37.7 ,32.8 ,28.8 ,25.6 ,
	22.5 ,19.8 ,16.9 ,13.9 ,11. ,8.2 ,5.7 ,2.9 ,.3 ,-2.2 ,-4.6 ,-6.9 ,
	-9. ,-11. ,-13. ,-15. ,-17. ,-18.9 ,-20.9 ,-22.5 ,-24.6 ,-26.3 ,
	-28. ,70.5 ,59. ,51.7 ,45.4 ,40. ,34.9 ,30.4 ,27. ,23.9 ,21. ,
	18.2 ,15.1 ,12.3 ,9.7 ,6.9 ,4.1 ,1.6 ,-1. ,-3.4 ,-5.7 ,-8. ,-10. ,
	-12. ,-14. ,-16. ,-17.9 ,-19.9 ,-21.7 ,-23.6 ,-25.4 ,-27.2 ,72.3 ,
	60.9 ,53.7 ,47.5 ,41.9 ,36.8 ,32. ,28.4 ,25. ,22. ,19.2 ,16.2 ,
	13.4 ,10.7 ,8. ,5.3 ,2.7 ,0. ,-2.5 ,-4.9 ,-7. ,-9. ,-11.2 ,-13.2 ,
	-15.1 ,-17. ,-19. ,-21. ,-23. ,-24.6 ,-26.2 ,74.2 ,63. ,56. ,50. ,
	44.4 ,39.2 ,34.9 ,30.8 ,27. ,23.9 ,20.8 ,17.8 ,14.8 ,12. ,9.1 ,
	6.7 ,3.9 ,1.1 ,-1.4 ,-3.9 ,-6. ,-8. ,-10.2 ,-12.2 ,-14.2 ,-16.2 ,
	-18.1 ,-20. ,-22. ,-23.7 ,-25.4 ,75.9 ,64.8 ,57.9 ,52. ,46.7 ,
	41.6 ,37.1 ,33. ,29. ,25.5 ,22. ,19. ,16. ,13.2 ,10.3 ,7.9 ,5. ,
	2.2 ,-.2 ,-2.8 ,-5. ,-7. ,-9.2 ,-11.3 ,-13.3 ,-15.3 ,-17.2 ,
	-19.2 ,-21.1 ,-22.8 ,-24.5 ,77. ,66.2 ,59.6 ,54. ,48.5 ,43.5 ,
	39.2 ,35. ,30.8 ,26.9 ,23.2 ,20. ,17.1 ,14.2 ,11.6 ,9. ,6. ,3.3 ,
	.9 ,-1.8 ,-4. ,-6.2 ,-8.2 ,-10.5 ,-12.5 ,-14.6 ,-16.3 ,-18.4 ,
	-20.2 ,-22. ,-23.8 ,78.2 ,67.6 ,60.9 ,55.2 ,50. ,45. ,40.7 ,36.2 ,
	32. ,28. ,24.1 ,21. ,18. ,15.3 ,12.5 ,10. ,7. ,4.4 ,1.8 ,-.8 ,
	-3. ,-5.3 ,-7.4 ,-9.8 ,-11.8 ,-14. ,-15.8 ,-17.8 ,-19.6 ,-21.3 ,
	-23. ,80.8 ,71.2 ,64.5 ,58.9 ,53.9 ,49. ,44.2 ,39.8 ,35.4 ,31.3 ,
	27.6 ,24.4 ,21.6 ,18.9 ,16. ,13.6 ,10.7 ,8. ,5.2 ,2.8 ,.3 ,-2. ,
	-4.5 ,-7. ,-9. ,-11.1 ,-13.2 ,-15. ,-17. ,-19. ,-21. ,81.8 ,73.8 ,
	67. ,61.4 ,56.3 ,51.7 ,46.9 ,42. ,37.8 ,33.8 ,30. ,27. ,24.1 ,
	21.5 ,18.8 ,16.1 ,13.6 ,10.9 ,8.1 ,5.3 ,3. ,.4 ,-1.9 ,-4.3 ,-6.7 ,
	-9. ,-11. ,-12.9 ,-14.9 ,-16.9 ,-18.9 ,82.2 ,75.5 ,69. ,63.3 ,
	58.4 ,53.5 ,48.8 ,44. ,39.7 ,35.7 ,32.1 ,29.1 ,26.1 ,23.5 ,20.9 ,
	18. ,15.7 ,13. ,10.2 ,7.5 ,5. ,2.6 ,0. ,-2.4 ,-4.6 ,-6.9 ,-9. ,
	-11. ,-13. ,-15. ,-17., 0.0
	];
	
//console.log('F51LV: ' + F51LV.length);

//***********************************************************************
//  F(50,50) FIELD STRENGTH DATA FOR THE HIGH VHF PROPAGATION CURVE  ( TV CHANNELS 7 THROUGH 13 ) -- (13 points * 25 rows = 325) + 1
//*********************************************************************/

var F55HV = [
	94.6 ,82.8 ,75.7 ,
	70.7 ,66.8 ,55. ,42.5 ,34. ,26.3 ,20.7 ,16.3 ,12.9 ,9.9 ,7. ,4.3 ,
	1.5 ,-1. ,-3.5 ,-5.7 ,-8. ,-10.4 ,-12.8 ,-15. ,-17.2 ,-19.1 ,
	100.7 ,88.9 ,81.8 ,76.9 ,73. ,61. ,48.6 ,40. ,32. ,24.1 ,18.5 ,
	14.4 ,11.2 ,8.3 ,5.5 ,2.9 ,.5 ,-2. ,-4.3 ,-6.9 ,-9.2 ,-11.5 ,
	-13.8 ,-16. ,-18.2 ,101.6 ,92.3 ,86.6 ,82.2 ,78.8 ,67.2 ,54.7 ,
	46.1 ,38.1 ,30.1 ,23. ,17. ,13.5 ,10.5 ,7.5 ,4.8 ,2.3 ,-.3 ,-2.7 ,
	-5. ,-7.3 ,-9.8 ,-12. ,-14.4 ,-16.8 ,101.8 ,93.9 ,88.7 ,84.8 ,
	81.6 ,70.8 ,58.1 ,49.8 ,41.7 ,33.8 ,26.2 ,20. ,15.2 ,12. ,9. ,
	6.2 ,3.7 ,1. ,-1.2 ,-3.7 ,-6. ,-8.4 ,-10.7 ,-13. ,-15.5 ,101.9 ,
	94.6 ,89.8 ,86.2 ,83.2 ,73.2 ,60.7 ,52.1 ,44. ,36.1 ,28.8 ,22.1 ,
	17. ,13.7 ,10.4 ,7.5 ,4.8 ,2.2 ,-.1 ,-2.5 ,-4.9 ,-7.3 ,-9.7 ,
	-12. ,-14.4 ,102. ,95. ,90.5 ,87. ,84.5 ,75. ,62.5 ,54.2 ,46. ,
	38. ,30.6 ,24. ,18.9 ,15. ,11.5 ,8.6 ,5.8 ,3.2 ,.9 ,-1.5 ,-4. ,
	-6.3 ,-8.7 ,-11. ,-13.4 ,102.3 ,95.4 ,91.3 ,88. ,85.7 ,77. ,65. ,
	56.7 ,48.8 ,40.9 ,33.5 ,26.8 ,21.2 ,17. ,13.1 ,10. ,7. ,4.4 ,2. ,
	-.5 ,-3. ,-5.3 ,-7.6 ,-10. ,-12.3 ,102.3 ,95.7 ,91.8 ,88.7 ,86.3 ,
	78.1 ,67.6 ,59. ,51. ,43.5 ,36.3 ,29.6 ,23.9 ,19. ,14.9 ,11.2 ,
	8.2 ,5.5 ,3. ,.6 ,-2. ,-4.3 ,-6.6 ,-9. ,-11.3 ,102.3 ,95.9 ,92. ,
	89.1 ,87. ,79.1 ,69.5 ,61. ,53.3 ,46. ,39. ,32. ,26. ,21. ,16.2 ,
	12.7 ,9.5 ,6.5 ,4. ,1.5 ,-1. ,-3.5 ,-5.8 ,-8.2 ,-10.5 ,102.4 ,
	96. ,92.1 ,89.5 ,87.3 ,80. ,71. ,62.8 ,55. ,47.9 ,41. ,34. ,28. ,
	22.6 ,17.5 ,13.6 ,10.5 ,7.4 ,4.9 ,2.2 ,-.2 ,-2.6 ,-5. ,-7.3 ,
	-9.8 ,102.4 ,96.2 ,92.6 ,90. ,88. ,81.1 ,73.9 ,66.3 ,58.7 ,52. ,
	45. ,38.2 ,32. ,26.3 ,21.1 ,17. ,14. ,10.7 ,8. ,5.6 ,3. ,.6 ,
	-1.8 ,-4.2 ,-6.6 ,102.4 ,96.2 ,92.6 ,90. ,88. ,81.8 ,74.8 ,67.4 ,
	60.3 ,53.8 ,47. ,40.6 ,34.4 ,28.8 ,23.8 ,19.8 ,16.6 ,13.1 ,10.4 ,
	8.2 ,5.5 ,3.1 ,.9 ,-1.8 ,-4. ,102.5 ,96.5 ,92.7 ,90.1 ,88. ,82. ,
	75. ,68. ,61.1 ,54.6 ,48.1 ,42. ,36.1 ,30.6 ,25.5 ,21.8 ,18.5 ,
	15.1 ,12.3 ,10.1 ,7.5 ,5.1 ,2.9 ,.3 ,-1.9, 0.0
	];
	
	//console.log('F55HV: ' + F55HV.length);
	
//***********************************************************************
//   F(50,10) FIELD STRENGTH DATA FOR THE HIGH VHF PROPAGATION CURVE  ( TV CHANNELS 7 THROUGH 13 ) -- (13 points * 31 curves = 403) + 1                               *
//***********************************************************************/
// Includes a derived Interfering curve (31) to smooth out the graph and interpolation for the rarely used F(50,10) curve at 498.89644 km
// was [31][13]  

var F51HV = [
	55.4 ,44.4 ,39.2 ,34. ,
	29.9 ,26.6 ,23.5 ,20.3 ,17.4 ,14.3 ,11.3 ,8.6 ,5.8 ,2.9 ,.3 ,
	-2.1 ,-4.4 ,-6.7 ,-8.9 ,-10.8 ,-12.9 ,-14.8 ,-16.9 ,-18.8 ,-20.7 ,
	-22.7 ,-24.6 ,-26.4 ,-28.2 ,-30.1 ,-32. ,61.6 ,50. ,43.5 ,38. ,
	32.5 ,28.2 ,25. ,22. ,19. ,16. ,13. ,10. ,7.2 ,4.7 ,1.9 ,-.7 ,
	-3.2 ,-5.4 ,-7.8 ,-9.8 ,-11.8 ,-13.8 ,-15.8 ,-17.7 ,-19.7 ,-21.4 ,
	-23.3 ,-25.2 ,-27.1 ,-29. ,-30.9 ,67.7 ,55.8 ,48.6 ,42.7 ,35.9 ,
	31. ,27. ,24. ,21. ,18.1 ,15.1 ,12.2 ,9.4 ,6.8 ,3.8 ,1.2 ,-1.4 ,
	-3.8 ,-6.1 ,-8.2 ,-10.3 ,-12.3 ,-14.3 ,-16.3 ,-18.3 ,-20.1 ,-22. ,
	-24. ,-25.9 ,-27.7 ,-29.5 ,71. ,59.1 ,52. ,45.6 ,38.8 ,33.4 ,
	28.9 ,25.5 ,22.4 ,19.6 ,16.7 ,13.7 ,10.8 ,8.1 ,5.2 ,2.7 ,0. ,
	-2.3 ,-4.8 ,-7. ,-9. ,-11.1 ,-13.1 ,-15.1 ,-17. ,-19. ,-20.9 ,
	-22.9 ,-24.8 ,-26.5 ,-28.2 ,73.5 ,61.7 ,54.6 ,48. ,41. ,35.4 ,
	30.7 ,27. ,23.8 ,20.8 ,18. ,15. ,12. ,9.5 ,6.5 ,3.9 ,1.2 ,-1.2 ,
	-3.8 ,-6. ,-8.2 ,-10.2 ,-12.2 ,-14.2 ,-16.2 ,-18. ,-20. ,-21.9 ,
	-23.9 ,-25.5 ,-27.1 ,75.3 ,63.7 ,56.5 ,50. ,43. ,37.4 ,32.3 ,
	28.3 ,25. ,22. ,19.1 ,16.3 ,13.3 ,10.6 ,7.8 ,5. ,2.4 ,0. ,-2.6 ,
	-5. ,-7.1 ,-9.3 ,-11.2 ,-13.3 ,-15.3 ,-17.2 ,-19.1 ,-21. ,-23. ,
	-24.9 ,-26.7 ,77.1 ,66.5 ,59. ,52.5 ,45.8 ,40. ,35. ,30.4 ,26.9 ,
	23.5 ,20.5 ,17.6 ,14.7 ,12. ,9. ,6.4 ,3.7 ,1. ,-1.4 ,-4. ,-6. ,
	-8.2 ,-10.2 ,-12.3 ,-14.3 ,-16.2 ,-18.2 ,-20. ,-22. ,-23.9 ,
	-25.8 ,78.6 ,68.9 ,61.5 ,54.9 ,48.2 ,43. ,37.4 ,32.9 ,28.8 ,25. ,
	22. ,18.8 ,15.9 ,13. ,10.3 ,7.5 ,4.9 ,2.1 ,-.3 ,-3. ,-5.1 ,-7.4 ,
	-9.4 ,-11.4 ,-13.5 ,-15.4 ,-17.4 ,-19.2 ,-21.1 ,-23. ,-24.9 ,
	79.6 ,70.8 ,63.6 ,56.9 ,50.8 ,45.4 ,40. ,35. ,30.4 ,26.4 ,23. ,
	19.9 ,17. ,14.1 ,11.5 ,8.8 ,6. ,3.3 ,.8 ,-2. ,-4.2 ,-6.5 ,-8.6 ,
	-10.6 ,-12.8 ,-14.8 ,-16.8 ,-18.5 ,-20.3 ,-22.1 ,-23.9 ,80.4 ,
	72. ,65.2 ,58.8 ,53. ,47.6 ,42. ,36.8 ,32. ,27.7 ,24. ,20.7 ,18. ,
	15.2 ,12.5 ,9.8 ,7. ,4.3 ,1.7 ,-1. ,-3.3 ,-5.6 ,-7.8 ,-9.8 ,-12. ,
	-14. ,-16. ,-18. ,-19.6 ,-21.5 ,-23.4 ,82. ,75. ,68.6 ,62.5 ,57. ,
	52. ,46.8 ,41.5 ,35.8 ,31. ,27.6 ,24. ,21.4 ,18.8 ,16. ,13.1 ,
	10.6 ,7.9 ,5. ,2.5 ,0. ,-2.4 ,-4.7 ,-6.9 ,-9. ,-11.1 ,-13.1 ,
	-15.1 ,-17. ,-19. ,-21. ,82.4 ,75.9 ,69.8 ,64. ,58.9 ,53.8 ,48.9 ,
	43.7 ,38.2 ,33.6 ,30. ,26.8 ,24. ,21.2 ,18.7 ,15.9 ,13.2 ,10.6 ,
	8. ,5.2 ,2.8 ,.2 ,-2. ,-4.3 ,-6.5 ,-9. ,-11. ,-13. ,-15. ,-16.8 ,
	-18.6 ,82.5 ,76.2 ,70.2 ,64.9 ,59.8 ,54.8 ,50. ,45. ,40.1 ,35.5 ,
	32. ,28.9 ,26. ,23.4 ,20.7 ,18. ,15.4 ,12.8 ,10. ,7.3 ,4.9 ,2.2 ,
	-.1 ,-2.4 ,-4.7 ,-7. ,-9. ,-11. ,-13. ,-15. ,-17., 0.0
	];
	
		//console.log('F51HV: ' + F51HV.length);
	
//***********************************************************************
//   F(50,50) FIELD STRENGTH DATA FOR THE UHF PROPAGATION CURVE ( TV CHANNELS 14 THROUGH 83 ) -- (13 points * 25 curves = 325) + 1                                       *
//***********************************************************************/
// was [25][13]

var  F55U = [
	92. ,80. ,72.9 ,67.9 ,
	63.8 ,51.9 ,39. ,27.5 ,17.8 ,13. ,10.1 ,7. ,4.2 ,1.6 ,-1. ,-3.2 ,
	-5. ,-7.2 ,-9.1 ,-11. ,-13.1 ,-15.1 ,-17.2 ,-19.3 ,-21.4 ,97.9 ,
	86. ,79. ,74. ,70. ,58. ,45.2 ,33.5 ,22.7 ,16. ,11.7 ,8.5 ,5.5 ,
	2.8 ,.2 ,-2. ,-4.2 ,-6.3 ,-8.4 ,-10.3 ,-12.3 ,-14.2 ,-16.2 ,
	-18.3 ,-20.1 ,100.7 ,91. ,84.7 ,80. ,76. ,64. ,51.2 ,39.6 ,28.2 ,
	19.6 ,14.4 ,10.8 ,7.7 ,4.7 ,1.9 ,-.4 ,-2.7 ,-4.9 ,-7. ,-8.9 ,
	-10.9 ,-12.8 ,-14.8 ,-16.8 ,-18.7 ,101.5 ,93. ,87.4 ,83.3 ,79.5 ,
	67.6 ,54.6 ,43. ,31.5 ,22.3 ,16.8 ,12.5 ,9.3 ,6. ,3.2 ,.7 ,-1.5 ,
	-3.8 ,-5.9 ,-7.9 ,-9.9 ,-11.7 ,-13.8 ,-15.8 ,-17.7 ,101.9 ,94.1 ,
	89. ,85.1 ,81.5 ,70. ,57.2 ,45.7 ,34.5 ,25.1 ,19.1 ,14.2 ,10.8 ,
	7.5 ,4.6 ,1.9 ,-.4 ,-2.9 ,-5. ,-7. ,-9. ,-10.8 ,-12.8 ,-14.8 ,
	-16.8 ,102. ,94.8 ,90. ,86.3 ,82.9 ,72. ,59.1 ,48. ,37.3 ,28.3 ,
	21.7 ,16.3 ,12.4 ,8.9 ,5.7 ,3. ,.5 ,-2. ,-4.2 ,-6.1 ,-8. ,-10. ,
	-11.9 ,-13.9 ,-15.9 ,102.1 ,95.2 ,90.8 ,87.3 ,84.1 ,73.8 ,61. ,
	50.5 ,40.3 ,31.8 ,24.7 ,19. ,14.5 ,10.6 ,7.1 ,4.3 ,1.7 ,-.9 ,
	-3.2 ,-5.2 ,-7.1 ,-9. ,-11. ,-13. ,-15. ,102.2 ,95.6 ,91.3 ,88. ,
	85. ,75.3 ,62.6 ,52.3 ,42.7 ,34.1 ,27. ,21.3 ,16.3 ,12. ,8.5 ,
	5.6 ,2.8 ,0. ,-2.3 ,-4.3 ,-6.2 ,-8.2 ,-10.2 ,-12.2 ,-14.1 ,102.3 ,
	95.9 ,91.8 ,88.6 ,85.8 ,76.5 ,64. ,53.9 ,44.3 ,36. ,29.3 ,23.4 ,
	18. ,13.6 ,9.7 ,6.7 ,3.8 ,1. ,-1.6 ,-3.6 ,-5.5 ,-7.5 ,-9.5 ,
	-11.4 ,-13.2 ,102.4 ,96. ,92. ,88.9 ,86.2 ,77.2 ,65. ,55. ,45.7 ,
	37.6 ,31. ,25. ,19.8 ,15. ,10.8 ,7.7 ,4.8 ,1.9 ,-.9 ,-3. ,-4.8 ,
	-6.8 ,-8.9 ,-10.8 ,-12.5 ,102.5 ,96.3 ,92.5 ,89.6 ,87.3 ,79.6 ,
	68.2 ,58.4 ,49.4 ,41.7 ,35.4 ,29.8 ,24.5 ,19.8 ,15. ,11.5 ,8.2 ,
	5. ,2. ,-.2 ,-2.2 ,-4.3 ,-6.3 ,-8.3 ,-10. ,102.5 ,96.5 ,92.8 ,
	90. ,87.9 ,80.5 ,70. ,60.8 ,52.1 ,44.8 ,38.6 ,33. ,28. ,23.4 ,
	18.8 ,14.8 ,11.1 ,7.8 ,4.6 ,1.9 ,-.1 ,-2.2 ,-4.2 ,-6.1 ,-8. ,
	102.5 ,96.5 ,93. ,90.3 ,88.1 ,81. ,71.1 ,62.5 ,54. ,46.7 ,41. ,
	35.7 ,30.8 ,26. ,21.8 ,17.5 ,13.7 ,10. ,6.7 ,3.7 ,1.7 ,-.4 ,-2.3 ,
	-4.4 ,-6.3, 0.0
	];
	
//console.log('F55U: ' + F55U.length);
	
//***********************************************************************
//   F(50,10) FIELD STRENGTH DATA FOR THE UHF PROPAGATION CURVE ( TV CHANNELS 14 THROUGH 83 )  - (13 points * 31 curves = 403) + 1                                     *
//***********************************************************************/
// Includes a derived Interfering curve (31) to smooth out the graph and interpolation for the rarely used F(50,10) curve at 498.89644 km
// was [31][13]  

var F51U = [
	52.2 ,41.6 ,35. ,30.3 ,
	27. ,23.8 ,20.8 ,17.8 ,14.8 ,12. ,9.2 ,6.6 ,4. ,1.2 ,-1.3 ,-3.8 ,
	-6. ,-8.4 ,-10.3 ,-12.5 ,-14.5 ,-16.5 ,-18.5 ,-20.5 ,-22.4 ,
	-24.2 ,-26. ,-27.8 ,-29.5 ,-31. ,-32.5 ,58.3 ,46.7 ,38. ,32.1 ,
	28.3 ,25.2 ,22.2 ,19.3 ,16.5 ,13.4 ,10.7 ,8. ,5.1 ,2.5 ,-.2 ,
	-2.4 ,-4.9 ,-7.2 ,-9.3 ,-11.3 ,-13.5 ,-15.5 ,-17.4 ,-19.3 ,-21.3 ,
	-23.2 ,-25. ,-27. ,-28.5 ,-30.1 ,-31.6 ,64.7 ,52.4 ,43. ,35.3 ,
	30.8 ,27.6 ,24.5 ,21.3 ,18.5 ,15.6 ,12.7 ,9.9 ,7.1 ,4.4 ,1.8 ,
	-.8 ,-3.1 ,-5.5 ,-7.7 ,-9.8 ,-12. ,-14. ,-15.9 ,-17.8 ,-19.8 ,
	-21.6 ,-23.4 ,-25.5 ,-27.1 ,-28.9 ,-30.7 ,68. ,56. ,46.3 ,37.6 ,
	32.6 ,29.1 ,26. ,23. ,20. ,17.1 ,14. ,11.2 ,8.8 ,6. ,3.2 ,.8 ,
	-1.7 ,-4.1 ,-6.2 ,-8.4 ,-10.4 ,-12.7 ,-14.6 ,-16.5 ,-18.6 ,-20.4 ,
	-22.2 ,-24.2 ,-26. ,-27.9 ,-29.8 ,70.5 ,58.5 ,48.8 ,40. ,34.7 ,
	30.4 ,27.2 ,24.2 ,21.2 ,18.3 ,15.2 ,12.6 ,10. ,7.3 ,4.6 ,1.9 ,
	-.5 ,-3. ,-5.2 ,-7.4 ,-9.6 ,-11.7 ,-13.8 ,-15.6 ,-17.7 ,-19.6 ,
	-21.3 ,-23.3 ,-25. ,-27. ,-29. ,72.3 ,60.3 ,50.8 ,42.4 ,36.7 ,
	32. ,28.4 ,25.4 ,22.4 ,19.7 ,16.5 ,13.8 ,11. ,8.3 ,5.7 ,3. ,.6 ,
	-2. ,-4.3 ,-6.6 ,-8.8 ,-10.8 ,-13. ,-14.9 ,-17. ,-18.9 ,-20.8 ,
	-22.7 ,-24.4 ,-26.3 ,-28.2 ,74.1 ,62.3 ,52.9 ,45.1 ,39. ,34.5 ,
	30.4 ,27. ,23.9 ,21. ,18. ,15.3 ,12.5 ,9.7 ,7. ,4.4 ,1.8 ,-.7 ,
	-3.2 ,-5.4 ,-7.7 ,-9.8 ,-12. ,-14. ,-16. ,-17.9 ,-19.9 ,-21.8 ,
	-23.7 ,-25.6 ,-27.5 ,75.4 ,63.9 ,54.9 ,47.1 ,40.8 ,36.4 ,32.2 ,
	28.8 ,25.2 ,22.1 ,19.3 ,16.4 ,13.8 ,10.9 ,8.1 ,5.6 ,2.9 ,.3 ,
	-2.2 ,-4.5 ,-6.7 ,-8.9 ,-11. ,-13. ,-15. ,-17. ,-19.1 ,-21. ,
	-22.8 ,-24.8 ,-26.8 ,76.4 ,65.2 ,56.3 ,48.7 ,42.4 ,37.9 ,33.9 ,
	30.2 ,26.6 ,23.4 ,20.3 ,17.3 ,14.8 ,11.9 ,9.1 ,6.7 ,3.9 ,1.3 ,
	-1.2 ,-3.6 ,-5.8 ,-7.9 ,-10. ,-12.2 ,-14.2 ,-16.2 ,-18.2 ,-20.2 ,
	-22. ,-24. ,-26. ,77.4 ,66.2 ,57.6 ,50. ,43.7 ,39. ,35.1 ,31.7 ,
	27.8 ,24.6 ,21.3 ,18.3 ,15.7 ,12.8 ,10. ,7.6 ,4.8 ,2.1 ,-.4 ,
	-2.8 ,-5. ,-7.1 ,-9.2 ,-11.3 ,-13.4 ,-15.4 ,-17.5 ,-19.4 ,-21.3 ,
	-23.2 ,-25.1 ,79.5 ,69.3 ,60.9 ,53.6 ,47.7 ,43.1 ,39.2 ,35.8 ,
	32. ,28.3 ,24.9 ,21.7 ,18.8 ,15.9 ,13.1 ,10.6 ,7.9 ,5.1 ,2.2 ,0. ,
	-2.2 ,-4.3 ,-6.6 ,-8.9 ,-11. ,-13. ,-15. ,-17. ,-19. ,-21. ,
	-22.9 ,80.7 ,71.2 ,63. ,56.1 ,50.2 ,46. ,42.1 ,38.7 ,35. ,31.3 ,
	27.8 ,24.3 ,21.2 ,18.2 ,15.5 ,12.8 ,10. ,7.3 ,4.7 ,2.1 ,0. ,-2.2 ,
	-4.6 ,-6.8 ,-8.8 ,-10.8 ,-12.9 ,-14.9 ,-16.9 ,-18.9 ,-20.9 ,81.3 ,
	72.6 ,64.5 ,58. ,52.4 ,48. ,44.3 ,40.7 ,37.3 ,33.8 ,30.3 ,27. ,
	23.7 ,20.5 ,17.4 ,14.7 ,12. ,9.2 ,6.5 ,4. ,1.8 ,-.4 ,-2.8 ,-5. ,
	-7. ,-9. ,-11. ,-13. ,-15. ,-16.8 ,-18.6, 0.0
	];
//console.log('F51U: ' + F51U.length);
	
// ========The following data is needed for fzq to calculate F(50,90) or other curves ================//

//VGRID: 115 data points
var VGRID = [.01,.02,.03,.04,.05,.06,.07,.08,.09,.1,.15,.2,.3,.4,.5,.6,.7,.8,.9,1.,1.2,1.4,1.6,1.8,2.,3.,4.,5.,6.,7.,8.,9.,10.,11.,12.,13.,14.,15.,16.,17.,18.,19.,20.,22.,24.,26.,28.,30.,32.,34.,36.,38.,40.,42.,44.,46.,48.,50.,52.,54.,56.,58.,60.,62.,64.,66.,68.,70.,72.,74.,76.,78.,80.,81.,82.,83.,84.,85.,86.,87.,88.,89.,90.,91.,92.,93.,94.,95.,96.,97.,98.,98.2,98.4,98.6,98.8,99.,99.1,99.2,99.3,99.4,99.5,99.6,99.7,99.8,99.85,99.9,99.91,99.92,99.93,99.94,99.95,99.96,99.97,99.98,99.99];

//ZGRI: 58 data points
var ZGRI = [-3.71902,-3.54008,-3.43161,-3.35279,-3.29053,-3.23888,-3.19465,-3.15591,-3.12139,-3.09023,-2.96774,-2.87816,-2.74778,-2.65207,-2.57583,-2.51214,-2.45726,-2.40892,-2.36562,-2.32635,-2.25713,-2.19729,-2.14441,-2.09693,-2.05375,-1.88079,-1.75069,-1.64485,-1.55477,-1.47579,-1.40507,-1.34076,-1.28155,-1.22653,-1.17499,-1.12639,-1.08032,-1.03643,-.99446,-.95416,-.91537,-.8779,-.84162,-.77219,-.7063,-.64335,-.58284,-.5244,-.4677,-.41246,-.35846,-.30548,-.25335,-.20189,-.15097,-.10043,-.05015,0.0];

//console.log('VGRID: ' + VGRID.length);
//console.log('ZGRI: ' + ZGRI.length);

var F, H, D;

var F55LV_2d = makeArray(F55LV, 13, 25);
var F51LV_2d = makeArray(F51LV, 13, 31);
var F55HV_2d = makeArray(F55HV, 13, 25);
var F51HV_2d = makeArray(F51HV, 13, 31);
var F55U_2d = makeArray(F55U, 13, 25);
var F51U_2d = makeArray(F51U, 13, 31);

//var i;

function calTvFmDist(antennaHeight, fieldStrength, curveType) {
//antennaHeight: antennaHeight in meters
//fieldStrength: dB above 1 uV/m for 1kw ERP
//curveType:
	//F55LV: use F(50, 50) for FM and NTSC TV channels 2 to 6
	//F51LV: use F(50, 10) for FM and NTSC TV channels 2 to 6
	//F55HV: use F(50, 50) for NTSC TV channels 7 to 13
	//F51HV: use F(50, 10) for NTSC TV channels 7 to 13
	//F55U:  use F(50, 50) for NTSC TV channels 14 to 69
	//F51U:  use F(50, 10) for NTSC TV channels 14 to 69
	
	if (antennaHeight < 30) {
		antennaHeight = 30;
	}
	
	if (antennaHeight > 1600) {
		antennaHeight = 1600;
	}
	
	
	try {
	
	var i;

	if (curveType == 'F55LV') {
		F = F55LV_2d;
		D = D50;
		H = H50;
	}
	if (curveType == 'F51LV') {
		F = F51LV_2d;
		D = D10;
		H = H10;
	}
	if (curveType == 'F55HV') {
		F = F55HV_2d;
		D = D50;
		H = H50;
	}
	if (curveType == 'F51HV') {
		F = F51HV_2d;
		D = D10;
		H = H10;
	}
	if (curveType == 'F55U') {
		F = F55U_2d;
		D = D50;
		H = H50;
	}
	if (curveType == 'F51U') {
		F = F51U_2d;
		D = D10;
		H = H10;
	}
	
	var indice = getIndex(antennaHeight, H);
	var index1_h = indice[0];
	var index2_h = indice[1];
	
	//console.log("index1_h=" + index1_h + " index2_h=" + index2_h); 

	var field1;
	var field2;
	var index1_d;
	var index2_d;
	
	var distance = 0;
	for (var i = 0; i < D.length-1; i++) {
		index1_d = i;
		field1 = interpolateField(antennaHeight, index1_h, index2_h, index1_d, F);
		index2_d = i + 1;
		field2 = interpolateField(antennaHeight, index1_h, index2_h, index2_d, F);
		
		//console.log(antennaHeight + ' ' + field1 + ' ' + field2 + ' ' + fieldStrength + ' ' + D[i] + ' ' + D[i+1]);
		
		if (field1 >= fieldStrength && field2 <= fieldStrength) {
			//distance = D[i+1] - (fieldStrength - field2) * (D[i+1] - D[i]) / (field1 - field2);
			break;
		}
	}

	var index_center_h = index1_h;
	var index_other_h = index2_h;
	if (antennaHeight - H[index1_h] > H[index2_h] - antennaHeight) {
		index_center_h = index2_h;
		var index_other_h = index1_h;
	}
	
	var index_center_d = index1_d;
	var index_other_d = index2_d;
	if (F[index_center_h][index1_d] - fieldStrength > fieldStrength - F[index_center_h][index2_d]) {
		index_center_d = index2_d;
		var index_other_d = index1_d;
	}
	
	if (index1_h == 0 && index2_h == 0) {
	index_center_h = 1;
	index_other_h = 0;
	}
	
	if (index1_h == H.length-1 && index2_h == H.length-1) {
	index_center_h = H.length-2;
	index_other_h = H.length-1;
	}
	
	
	//console.log('index_center_h=' + index_center_h + ' index_center_d=' +  index_center_d + ' index_other_h=' + index_other_h + ' index_other_d=' + index_other_d);
	//console.log('H len:' + H.length + ' D len:' + D.length)

	
	var x = [];
	var y = [];
	var z = [];
	var index_x0 = index_center_h - (index_other_h - index_center_h);
	var index_y0 = index_center_d;
	x[0] = H[index_x0];
	y[0] = D[index_y0];
	z[0] = F[index_x0][index_y0];
	
	var index_x1 = index_center_h;
	var index_y1 = index_other_d;
	x[1] = H[index_x1];
	y[1] = D[index_y1];
	z[1] = F[index_x1][index_y1];
	
	var index_x2 = index_center_h;
	var index_y2 = index_center_d;
	x[2] = H[index_x2];
	y[2] = D[index_y2];
	z[2] = F[index_x2][index_y2];
	
	var index_x3 = index_center_h;
	var index_y3 = index_center_d - (index_other_d - index_center_d);
	x[3] = H[index_x3];
	y[3] = D[index_y3];
	z[3] = F[index_x3][index_y3];

	var index_x4 = index_other_h;
	var index_y4 = index_other_d;
	x[4] = H[index_x4];
	y[4] = D[index_y4];
	z[4] = F[index_x4][index_y4];
	
	var index_x5 = index_other_h;
	var index_y5 = index_center_d;
	x[5] = H[index_x5];
	y[5] = D[index_y5];
	z[5] = F[index_x5][index_y5];
	
	var m = [];

	for (var i = 0; i < x.length; i++) {
	m[i] = [x[i]*x[i], x[i]*y[i], y[i]*y[i], x[i], y[i], 1];
	}

	var mat = math.matrix(m);
	var mat_inv = math.inv(mat);
	var coef = math.multiply(mat_inv, z);

	var d = findD(antennaHeight, fieldStrength, coef._data, index_center_d, index_other_d);

	return d;
	
	}
	catch(err) {
	console.log(err);
	
	return -1;

	}


}


function findD(antennaHeight, fieldStrength, coef, index_center_d, index_other_d) {

	var a = coef[2];
	var b = coef[1]*antennaHeight + coef[4];
	var c = coef[0]*antennaHeight*antennaHeight + coef[3]*antennaHeight + coef[5] - fieldStrength;
	var insqroot = b*b - 4*a*c;

	var y_use;
	if (insqroot >= 0) {
	var y1 = (-1*b + Math.sqrt(insqroot)) / (2*a);
	var y2 = (-1*b - Math.sqrt(insqroot)) / (2*a);
	var average_d = (D[index_center_d] + D[index_other_d]) / 2;
	var y_use;
	if (Math.abs(average_d - y1) <= Math.abs(y2 - average_d)) {
		y_use = y1;
	}
	else {
		y_use = y2;
	}

	y_use = math.round(y_use, 1);
	}

	return y_use;
}


function getZ(x,y, coef) {
	var v = coef[0]*x*x + coef[1]*x*y + coef[2]*y*y + coef[3]*x + coef[4]*y + coef[5];
	return v;
}

function interpolateField(antennaHeight, index1_h, index2_h, index_d, F) {
	if (index1_h == index2_h) {
		return F[index1_h][index_d];
	}
	else {
		return (F[index1_h][index_d]*(antennaHeight - H[index1_h]) + F[index2_h][index_d]*(H[index2_h] - antennaHeight)) / (H[index2_h] - H[index1_h]);
	}
}

function getIndex(value, X) {

//console.log('value: ' + value);
//console.log('X: ' + X)

	var i;

	var index1 = -1;
	var index2 = -1;
	for (i = 0; i < X.length; i++) {
		if (value == X[i]) {
			index1 = i;
			index2 = i+1;
			break;
		}
	}
	
	if (index1 == -1 && index2 == -1) {
		for (i = 0; i < X.length-1; i++) {
			if (value > X[i] && value < X[i+1]) {
				index1 = i;
				index2 = i + 1;
				break;
			}
		}
	}
	
	if (value >= X[X.length-1]) {
		index1 = X.length-1;
		index2 = X.length-1;
	}
	
	if (value <= X[0]) {
		index1 = 0;
		index2 = 0;
	}
	
	return [index1, index2];
	
}

function makeArray(arr, nrow, ncol) {
	var i, j1, j2;
	var arr0 = []
	for (var i = 0; i < nrow; i++) {
		j1 = i*ncol;
		j2 = j1 + ncol;
		arr0.push(arr.slice(j1, j2));
	}
	
	return arr0;
}


function getDistance(req, res) {
	try {
	
	var haat = req.query.haat;
	var dbu = req.query.dbu;
	var curve_type = req.query.curve_type;
	
	if (haat == undefined) {
		res.status(400).send({
		'status': 'error',
		'statusCode':'400',
		'statusMessage': 'missing haat'
		});
		return;
	}
	
	if (dbu == undefined) {
		res.status(400).send({
		'status': 'error',
		'statusCode':'400',
		'statusMessage': 'missing dbu'
		});
		return;
	}
	
	if (curve_type == undefined) {
		res.status(400).send({
		'status': 'error',
		'statusCode':'400',
		'statusMessage': 'missing curve_type'
		});
		return;
	}
	
	var curveList = ['F55LV', 'F51LV', 'F55HV', 'F51HV', 'F55U', 'F51U'];
	
	var curve_type_uc = curve_type.toUpperCase();
	if (curveList.indexOf(curve_type_uc) == -1) {
		res.status(400).send({
		'status': 'error',
		'statusCode':'400',
		'statusMessage': 'wrong curve_type - must be F55LV, F51LV, F55HV, F51HV, F55U, or F51U'
		});
		return;
	}
	
	 if ( !haat.match(/\d+\.?\d*$/)) {
	 	res.status(400).send({
		'status': 'error',
		'statusCode':'400',
		'statusMessage': 'invalid haat value'
		});
		return;
	 }
	
	if ( !dbu.match(/-?\d+\.?\d*$/)) {
	 	res.status(400).send({
		'status': 'error',
		'statusCode':'400',
		'statusMessage': 'invalid dbu value'
		});
		return;
	 }
	
	
	
	
	var distance = calTvFmDist(haat, dbu, curve_type_uc);
	
	res.send(
	{'haat': haat,
	'haat_unit': 'm',
	'dbu': dbu,
	'curve_type': curve_type,
	'distance': distance,
	'distance_unit': 'km'
	});


	}
	catch(err) {
		console.log(err);
		res.status(400).send({
			'status': 'error',
        	'statusCode':'400',
        	'statusMessage': 'Error occurred',
			'error': err.stack
        });
	
	}


}



var antennaHeight = 100;
var fieldStrength = 28;
var curveType = 'F55LV';


var distance = calTvFmDist(antennaHeight, fieldStrength, curveType);
console.log("antennaHeight:" + antennaHeight + " fieldStrength:" + fieldStrength + " distance:" + distance);


module.exports.calTvFmDist = calTvFmDist;
module.exports.getDistance = getDistance;


